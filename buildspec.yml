version: 0.2

# Environment variables
env:
  variables:
    JAVA_HOME: "/usr/lib/jvm/java-21-openjdk-amd64"
    MAVEN_OPTS: "-Dmaven.repo.local=/root/.m2/repository"

# Build phases
phases:
  install:
    runtime-versions:
      java: corretto21
    commands:
      - echo "ğŸš€ Installing dependencies..."
      - echo "Java version:"
      - java -version
      - echo "Maven version:"
      - mvn -version
      - echo "âœ… Installation phase completed"

  pre_build:
    commands:
      - echo "ğŸ”§ Pre-build phase started..."
      - echo "ğŸ“‚ Current directory: $(pwd)"
      - echo "ğŸ“‹ Listing project files:"
      - ls -la
      - echo "ğŸ” Checking pom.xml:"
      - cat pom.xml | head -20
      - echo "âœ… Pre-build phase completed"

  build:
    commands:
      - echo "ğŸ—ï¸ Build phase started..."
      
      # Run tests
      - echo "ğŸ§ª Running tests..."
      - mvn test
      
      # Build JAR file
      - echo "ğŸ“¦ Building JAR file..."
      - mvn clean package -DskipTests
      
      # Verify JAR file
      - echo "ğŸ” Verifying JAR file..."
      - ls -la target/
      - |
        if [ -f "target/slack.cab-0.0.1-SNAPSHOT.jar" ]; then
          echo "âœ… JAR file found: $(ls -lh target/slack.cab-0.0.1-SNAPSHOT.jar)"
          echo "ğŸ“Š JAR file size: $(du -h target/slack.cab-0.0.1-SNAPSHOT.jar)"
        else
          echo "âŒ JAR file not found!"
          exit 1
        fi
      
      - echo "âœ… Build phase completed successfully"

  post_build:
    commands:
      - echo "ğŸ¯ Post-build phase started..."
      - echo "ğŸ“‹ Final verification:"
      - ls -la target/
      - echo "ğŸ† Build completed successfully!"
      - echo "ğŸ“¦ Artifact ready: target/slack.cab-0.0.1-SNAPSHOT.jar"

# Artifacts to be uploaded to S3
artifacts:
  files:
    - target/slack.cab-0.0.1-SNAPSHOT.jar
  name: slack-cab-$(date +%Y-%m-%d-%H-%M-%S)
  base-directory: '.'

# Cache Maven dependencies for faster builds
cache:
  paths:
    - '/root/.m2/**/*'

# Reports (optional - for test results)
reports:
  surefire-reports:
    files:
      - '**/*'
    base-directory: 'target/surefire-reports'
    file-format: 'JUNITXML'
